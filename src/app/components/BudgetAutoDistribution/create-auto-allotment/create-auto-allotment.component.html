<div class="mainRoute">
    <div class="container-fluid">
        <secondBar>Create Auto Allotment</secondBar>

        <mat-accordion [hideToggle]="false">
            <mat-expansion-panel [hideToggle]="false" [expanded]="accordionStep === 0" (opened)="setAccordionStep(0)" class="formDesign mt-3">
                <mat-expansion-panel-header>
                    <mat-panel-title><strong>Search Criteria</strong></mat-panel-title>
                </mat-expansion-panel-header>
                <app-hoa-details (onEnteringHoaDetails)="filterHOA($event)"></app-hoa-details>
                <form [formGroup]="autoAllotmentForm">
                    <div class="row">
                        <div class="col-6">
                            <mat-form-field class="full-width" appearance="outline">
                                <input matInput type="text" (keyup)="searchTreasury($event)" placeholder="Treasury Code" [matAutocomplete]="treasuryCode" formControlName="tresuryCode" />
                                <mat-icon matSuffix>arrow_drop_down</mat-icon>
                                <mat-label>Treasury Code</mat-label>
                                <mat-autocomplete [displayWith]="displayFnTreasury" #treasuryCode="matAutocomplete" (optionSelected)="bindDdoForSelectedTreasury()">
                                    <mat-option class="ctm-auto-ddl" *ngFor="let treasury of treasuryList" [title]="treasury.code" (onSelectionChange)="onTreasurySelect($event, treasury.code, 0)" [value]="treasury"> {{ treasury.code }} : {{ treasury.name }} </mat-option>
                                </mat-autocomplete>
                                <mat-error><custom-mat-error [control]="autoAllotmentForm.controls.tresuryCode"></custom-mat-error></mat-error>
                            </mat-form-field>
                        </div>
                        <!-- <div class="col-6">
                            <mat-form-field class="full-width" appearance="outline">
                                <input matInput type="text" placeholder="DDO Code" [matAutocomplete]="cChild" (keyup)="searchDdo($event)" formControlName="ddoCode" />
                                <mat-icon matSuffix>arrow_drop_down</mat-icon>
                                <mat-label>DDO Code</mat-label>
                                <mat-autocomplete [displayWith]="displayFnDdoCode" #cChild="matAutocomplete">
                                    <mat-option class="ctm-auto-ddl" *ngFor="let ddo of ddoList" [title]="ddo.designation" [value]="ddo"> {{ ddo.code }} : {{ ddo.designation }} </mat-option>
                                </mat-autocomplete>
                                <mat-error><custom-mat-error [control]="autoAllotmentForm.controls.ddoCode"></custom-mat-error></mat-error>
                            </mat-form-field>
                        </div> -->
                    </div>
                </form>
                <mat-action-row>
                    <button mat-raised-button color="primary" (click)="getAutoallotmentData()">Next</button>
                </mat-action-row>
            </mat-expansion-panel>

            <mat-expansion-panel [hideToggle]="false" [expanded]="accordionStep === 1" (opened)="setAccordionStep(1)" class="formDesign mt-3">
                <mat-expansion-panel-header>
                    <mat-panel-title><strong>Averages of Previous 3 Year Data</strong></mat-panel-title>
                </mat-expansion-panel-header>
                <div class="row pt-0 pb-0">
                    <div class="col-12">
                        <div class="xformDesign">
                            <table mat-table matSort [dataSource]="copyAllotSource" class="mt-2 mat-elevation-z0 xformDesign full-width">
                                <ng-container matColumnDef="id">
                                    <th mat-header-cell mat-sort-header="id" class="mat-tab-header-txt-col" *matHeaderCellDef>ID</th>
                                    <td mat-cell *matCellDef="let element">{{ element.id }}</td>
                                </ng-container>

                                <ng-container matColumnDef="saoDdoCode">
                                    <th mat-header-cell mat-sort-header="saoDdoCode" class="mat-tab-header-txt-col" *matHeaderCellDef>DDO</th>
                                    <td mat-cell *matCellDef="let element">{{ element.ddoCode }}</td>
                                </ng-container>

                                <ng-container matColumnDef="hoa">
                                    <th mat-header-cell mat-sort-header="hoa" class="mat-tab-header-txt-col" *matHeaderCellDef>Head of Account</th>
                                    <td mat-cell *matCellDef="let element">{{ element.demandNo + "-" + element.majorHead + "-" + element.submajorHead + "-" + element.minorHead + "-" + element.schemeHead + "-" + element.detailHead + "-" + element.subdetailHead + "-" + element.votedCharged }}</td>
                                </ng-container>

                                <ng-container matColumnDef="percentage">
                                    <th mat-header-cell mat-sort-header="percentage" class="mat-tab-header-txt-col" *matHeaderCellDef>Distribution Percentage</th>
                                    <!-- <td mat-cell *matCellDef="let element"><input mat-input type="number" src="" alt="" [(ngModel)]="element.avgPercentage" /></td> -->
                                    <td mat-cell *matCellDef="let element">{{ element.avgPercentage }}</td>
                                </ng-container>

                                <ng-container matColumnDef="selection">
                                    <th mat-header-cell *matHeaderCellDef>
                                        <mat-checkbox (change)="$event ? masterToggle() : null" [checked]="clickedRows.size > 0 && isAllSelected()" [indeterminate]="clickedRows.size > 0 && !isAllSelected()"> </mat-checkbox>
                                    </th>
                                    <td mat-cell *matCellDef="let row">
                                        <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? tickRow($event, row) : null" [checked]="clickedRows.has(row)"> </mat-checkbox>
                                    </td>
                                </ng-container>

                                <tr mat-header-row class="col" *matHeaderRowDef="displayedColumns"></tr>
                                <tr mat-row [class.demo-row-is-clicked]="clickedRows.has(row)" *matRowDef="let row; columns: displayedColumns"></tr>

                                <tr class="mat-row" *matNoDataRow>
                                    <td class="mat-cell" colspan="4">No data matching the filter</td>
                                </tr>
                            </table>
                            <div class="d-flex justify-content-between">
                                <p class="pt-4">{{ clickedRows.size }} items selected.</p>
                                <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page of users"> </mat-paginator>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <form [formGroup]="autoAllotmentForm">
                    <div class="row">
                        <div class="col-4" style="margin-top: 12px">
                            <strong>Mention the number of days for keeping the auto allotment on hold :</strong>
                        </div>
                        <div class="col-2">
                            <mat-form-field class="full-width" appearance="outline">
                                <mat-label>Number of Days</mat-label>
                                <input matInput type="number" formControlName="numberOfDays" />
                                <mat-error><custom-mat-error [control]="autoAllotmentForm.controls.numberOfDays"></custom-mat-error></mat-error>
                            </mat-form-field>
                        </div>
                        <div class="col-3"></div>
                        <div class="col-3">
                            <strong>Total Percentage(%) : {{ totalPercentage }}</strong>
                        </div>
                    </div>
                </form> -->
                <mat-action-row>
                    <button mat-raised-button color="accent" (click)="goForAutoAllotment()" *ngIf="clickedRowsArray.length != 0">Next</button>
                </mat-action-row>
            </mat-expansion-panel>

            <mat-expansion-panel [hideToggle]="false" [expanded]="accordionStep === 2" (opened)="setAccordionStep(2)" class="formDesign" *ngIf="clickedRowsArray.length != 0">
                <mat-expansion-panel-header>
                    <mat-panel-title><strong>Auto Allot Fund</strong></mat-panel-title>
                </mat-expansion-panel-header>

                <div class="xformDesign mt-3">
                    <div class="row">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th style="text-align: center">ID</th>
                                    <th style="text-align: center">SAO/DDO</th>
                                    <th style="text-align: center">Head of Account</th>
                                    <th style="text-align: center">Distribution Percentage</th>
                                    <th style="text-align: center">Clear Row</th>
                                </tr>
                            </thead>

                            <tbody>
                                <ng-container *ngFor="let requisitionFormStruct of autoAllotmentFormArrayHelper.controls; let i = index">
                                    <tr [formGroup]="autoAllotmentFormArrayHelper.fromGroupAt(i)" style="text-align: center">
                                        <td>{{ this.clickedRowsArray[i]?.id }}</td>
                                        <td>{{ this.clickedRowsArray[i]?.ddoCode }}</td>
                                        <td>{{ this.clickedRowsArray[i]?.demandNo + "-" + this.clickedRowsArray[i]?.majorHead + "-" + this.clickedRowsArray[i]?.submajorHead + "-" + this.clickedRowsArray[i]?.minorHead + "-" + this.clickedRowsArray[i]?.schemeHead + "-" + this.clickedRowsArray[i]?.detailHead + "-" + this.clickedRowsArray[i]?.subdetailHead + "-" + this.clickedRowsArray[i]?.votedCharged }}</td>
                                        <td>
                                            <mat-form-field class="full-width" appearance="outline">
                                                <mat-label>Distribution Percentage</mat-label>
                                                <input matInput type="number" formControlName="autoAllotmentPercentage" required />
                                                <mat-error><custom-mat-error [control]="autoAllotmentFormArrayHelper.fromGroupAt(i).controls.autoAllotmentPercentage"></custom-mat-error></mat-error>
                                            </mat-form-field>
                                        </td>
                                        <td>
                                            <button class="mt-2" mat-mini-fab color="primary" (click)="deleteFormArrayEntry(i)"><mat-icon>clear</mat-icon></button>
                                        </td>
                                    </tr>
                                </ng-container>
                            </tbody>
                        </table>
                    </div>
                </div>

                <form [formGroup]="autoAllotmentForm">
                    <div class="row">
                        <div class="col-4" style="margin-top: 12px">
                            <strong>Mention the number of days for keeping the auto allotment on hold :</strong>
                        </div>
                        <div class="col-2">
                            <mat-form-field class="full-width" appearance="outline">
                                <mat-label>Number of Days</mat-label>
                                <input matInput type="number" formControlName="numberOfDays" />
                                <mat-error><custom-mat-error [control]="autoAllotmentForm.controls.numberOfDays"></custom-mat-error></mat-error>
                            </mat-form-field>
                        </div>
                        <div class="col-3"></div>
                        <!-- <div class="col-3">
                            <strong>Total Percentage(%) : {{ totalPercentage }}</strong>
                        </div> -->
                    </div>
                </form>
                <mat-action-row>
                    <button mat-raised-button color="primary" (click)="autoAllot()">Auto Allot</button>
                </mat-action-row>
            </mat-expansion-panel>
        </mat-accordion>
    </div>
</div>
